# Copyright 2025 The IREE Authors
#
# Licensed under the Apache License v2.0 with LLVM Exceptions.
# See https://llvm.org/LICENSE.txt for license information.
# SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception

name: PkgCI Test PJRT Metal plugin
on:
  workflow_call:
    inputs:
      write-caches:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      write-caches:
        required: false
        type: string
        default: "1"  # Enable cache saving by default for manual runs

jobs:
  build_and_test:
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-14
            name: macOS 14 (ARM64)
          - runner: macos-15
            name: macOS 15 (ARM64)
    name: Metal PJRT - ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}
    env:
      VENV_DIR: ${{ github.workspace }}/.venv
    defaults:
      run:
        shell: bash
    steps:
      - name: Checking out repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: true

      - name: Updating git submodules
        run: git submodule update --init --jobs 8 --depth 1

      # Select latest Xcode for Metal toolchain
      - name: Update Xcode command line tools path
        run: |
          sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
          xcrun metal --version
          xcrun metallib --version

      - name: Setting up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Installing requirements
        run: brew install ninja ccache coreutils bash

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: pjrt-metal-${{ runner.os }}-${{ runner.arch }}
          save: ${{ inputs.write-caches == '1' }}
          max-size: 2G

      - name: Cache CMake build directory
        uses: actions/cache@v4
        with:
          path: |
            integrations/pjrt/python_packages/iree_metal_plugin/build
          # v11: use pip iree-base-compiler instead of building from source
          key: cmake-pjrt-metal-v11-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('integrations/pjrt/CMakeLists.txt', 'integrations/pjrt/src/**') }}
          restore-keys: |
            cmake-pjrt-metal-v11-${{ runner.os }}-${{ runner.arch }}-

      - name: Clean stale CMake cache if needed
        run: |
          CACHE_FILE="integrations/pjrt/python_packages/iree_metal_plugin/build/cmake/CMakeCache.txt"
          if [ -f "$CACHE_FILE" ]; then
            # Check if cache has wrong architecture setting
            if grep -q "CMAKE_OSX_ARCHITECTURES:STRING=$" "$CACHE_FILE" 2>/dev/null; then
              echo "Removing stale CMake cache with wrong architecture"
              rm -rf integrations/pjrt/python_packages/iree_metal_plugin/build/cmake/CMakeCache.txt
              rm -rf integrations/pjrt/python_packages/iree_metal_plugin/build/cmake/CMakeFiles
            fi
          fi

      - name: Setup venv and install dependencies
        run: |
          python -m venv ${VENV_DIR}
          source ${VENV_DIR}/bin/activate
          pip install -r runtime/bindings/python/iree/runtime/build_requirements.txt
          # Install iree-base-compiler from pip for the libIREECompiler.dylib
          # Building it from source requires Shardy tablegen which isn't built by PJRT
          pip install iree-base-compiler
          pip install numpy jax jaxlib

      - name: Build and install Metal PJRT plugin
        env:
          CMAKE_C_COMPILER_LAUNCHER: ccache
          CMAKE_CXX_COMPILER_LAUNCHER: ccache
          # Set architecture to arm64 to prevent x86 SSE flags being applied by abseil
          CMAKE_OSX_ARCHITECTURES: arm64
          CMAKE_SYSTEM_PROCESSOR: arm64
          # Workaround for protobuf-bundled abseil adding x86 SIMD flags on ARM64
          # The flags are unused but cause errors on macOS 15's stricter Clang
          # Set via both CFLAGS/CXXFLAGS and CMAKE_*_FLAGS for maximum coverage
          CFLAGS: "-Wno-unused-command-line-argument"
          CXXFLAGS: "-Wno-unused-command-line-argument"
          CMAKE_C_FLAGS: "-Wno-unused-command-line-argument"
          CMAKE_CXX_FLAGS: "-Wno-unused-command-line-argument"
        run: |
          source ${VENV_DIR}/bin/activate
          echo "CMAKE_OSX_ARCHITECTURES=${CMAKE_OSX_ARCHITECTURES}"
          echo "CMAKE_SYSTEM_PROCESSOR=${CMAKE_SYSTEM_PROCESSOR}"
          echo "CMAKE_C_FLAGS=${CMAKE_C_FLAGS}"
          echo "CMAKE_CXX_FLAGS=${CMAKE_CXX_FLAGS}"
          # Build and install the PJRT plugin with Metal support
          # This builds the compiler from source for version compatibility
          pip install -v --no-deps integrations/pjrt/python_packages/iree_metal_plugin

      - name: Run Metal PJRT tests
        run: |
          source ${VENV_DIR}/bin/activate
          cd integrations/pjrt

          # Show where the PJRT plugin was installed
          python -c "import iree._pjrt_libs.metal as m; import os; print(f'Metal PJRT plugin: {os.path.dirname(m.__file__)}')"
          # Verify iree.compiler is available (from pip package)
          python -c "from iree.compiler.api import ctypes_dl; print(f'Compiler lib: {ctypes_dl._probe_iree_compiler_dylib()}')"

          # Note: macOS CI runners use paravirtualized GPUs which may not support
          # all Metal operations. Tests may fail due to VM GPU limitations.
          echo "Running Metal-specific tests..."
          JAX_PLATFORMS=iree_metal python test/test_metal.py || echo "Metal tests failed (possibly due to VM GPU limitations)"
          echo "Running Shardy dialect tests..."
          JAX_PLATFORMS=iree_metal python test/test_shardy.py || echo "Shardy tests failed (possibly due to VM GPU limitations)"

      - name: Run differential tests vs CPU
        run: |
          source ${VENV_DIR}/bin/activate
          cd integrations/pjrt

          # Compare Metal results with CPU baseline
          # Note: These tests may fail on VM GPUs due to paravirtualization limitations
          echo "Running differential tests (Metal vs CPU)..."

          diff_test_failed=0
          for test in test/test_add.py test/test_simple.py; do
            echo "Testing ${test}..."
            expected=$(JAX_PLATFORMS=cpu python ${test}) || { echo "CPU baseline failed for ${test}"; diff_test_failed=1; continue; }
            actual=$(JAX_PLATFORMS=iree_metal python ${test} 2>&1) || { echo "Metal execution failed for ${test} (possibly VM GPU limitation)"; diff_test_failed=1; continue; }
            if [ "$expected" != "$actual" ]; then
              echo "FAIL: Output mismatch for ${test}"
              echo "Expected: $expected"
              echo "Actual: $actual"
              diff_test_failed=1
            else
              echo "PASS: ${test}"
            fi
          done

          if [ $diff_test_failed -eq 1 ]; then
            echo "Some differential tests failed (possibly due to VM GPU limitations)"
          fi

      - name: Clone JAX repository for test suite
        run: |
          git clone --depth=1 https://github.com/jax-ml/jax.git /tmp/jax
          echo "JAX version: $(cat /tmp/jax/jax/version.py | grep __version__)"

      - name: Install JAX test dependencies
        run: |
          source ${VENV_DIR}/bin/activate
          pip install pytest absl-py hypothesis

      - name: Run JAX test suite
        timeout-minutes: 30  # Limit total test time to 30 minutes
        continue-on-error: true  # Don't fail CI on timeout - we're establishing baseline
        run: |
          source ${VENV_DIR}/bin/activate
          cd integrations/pjrt

          # Run a subset of JAX tests against IREE Metal
          # Use shorter timeout (15s) since most tests either pass quickly or fail
          # lax_test.py has thousands of tests - we sample what we can in 30 minutes
          echo "Running JAX test suite against IREE Metal..."
          echo "Note: Using 15s timeout per test, 30 minute total limit"
          JAX_PLATFORMS=iree_metal python test/test_jax.py \
            /tmp/jax/tests/lax_test.py \
            -j 4 \
            -t 15 \
            -l /tmp/jaxtest \
            -e test/metal_expected_passing.txt \
            -p /tmp/metal_passing.txt \
            -f /tmp/metal_failing.txt || true

          # Report results (don't fail CI yet - baseline is being established)
          echo ""
          echo "=== JAX Test Suite Results ==="
          if [ -f /tmp/metal_passing.txt ]; then
            echo "Passing tests: $(wc -l < /tmp/metal_passing.txt)"
          fi
          if [ -f /tmp/metal_failing.txt ]; then
            echo "Failing tests: $(wc -l < /tmp/metal_failing.txt)"
          fi

      - name: Upload test artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: jax-test-results-${{ matrix.runner }}
          path: |
            /tmp/jaxtest/
            /tmp/metal_passing.txt
            /tmp/metal_failing.txt
          retention-days: 7

      - name: Post to Discord on Failure
        uses: sarisia/actions-status-discord@b8381b25576cb341b2af39926ab42c5056cc44ed # v1.15.5
        if: failure() && github.ref_name == 'main' && github.repository_owner == 'iree-org'
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          description: "The ${{ github.workflow }} workflow failed on ${{ matrix.name }}"
          url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/attempts/${{ github.run_attempt }}"
